<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Validador SAF-T PT</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f7f9fb; }
    .container { max-width: 1100px; margin: auto; }
    .card { background: #fff; border-radius: 14px; padding: 18px; margin-bottom: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    .nav { margin-bottom: 12px; }
    .nav a { margin-right: 14px; text-decoration: none; font-weight: bold; }
    .ok { color: #1b5e20; }
    .error { color: #7f1d1d; }
    .muted { color: #6b7280; font-size: 12px; margin-top: 6px; }
    button { padding: 10px 16px; border-radius: 12px; border: none; cursor: pointer; background: #1976d2; color: white; font-weight: bold; }
    button:hover { background: #125ea6; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; background: #eef2ff; color:#1e40af; border:1px solid #c7d2fe; }

    /* Invoice style */
    .invoice-wrap { border: 1px solid #e5edf7; border-radius: 16px; overflow: hidden; }
    .inv-head { padding: 18px; background: linear-gradient(180deg,#0b1020,#111a33); color: #fff; }
    .inv-head-top { display:flex; justify-content:space-between; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .inv-title { font-size: 18px; font-weight: 800; margin: 0; }
    .inv-sub { font-size: 12px; opacity: .9; margin-top: 6px; line-height: 1.35; }
    .inv-badges { text-align:right; }
    .badge { display:inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.2); margin-left: 8px; }
    .inv-body { padding: 18px; background:#fff; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .box { background:#f3f6fa; border:1px solid #e5edf7; border-radius: 14px; padding: 14px; }
    .box h3 { margin: 0 0 10px 0; font-size: 13px; color:#111827; }
    .kv { font-size: 13px; color:#111827; line-height:1.5; }
    .kv b { color:#111827; }
    table { width:100%; border-collapse: collapse; margin-top: 14px; overflow: hidden; border-radius: 12px; }
    th, td { border-bottom: 1px solid #e5edf7; padding: 10px; font-size: 13px; vertical-align: top; }
    th { text-align:left; background:#f8fafc; font-size: 12px; color:#374151; }
    .right { text-align:right; }
    .totals { margin-top: 14px; display:flex; justify-content:flex-end; }
    .totals .box { width: 360px; }
    .tot-line { display:flex; justify-content:space-between; padding: 6px 0; font-size: 13px; }
    .tot-line strong { font-size: 15px; }
    .footnote { margin-top: 12px; font-size: 12px; color:#6b7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; word-break: break-all; }
  </style>
</head>
<body>
<div class="container">

  <!-- LINKS FIXOS (NUNCA REMOVER) -->
  <div class="nav">
    <a href="/">‚úÖ Validar SAF-T XML</a>
    <a href="/purchase-pdf">üìÑ Analisar Fatura PDF (OCR)</a>
  </div>

  <div class="card">
    <h1 style="margin-top:0;">Validador SAF-T (Portugal)</h1>
    <p class="muted">Valida√ß√£o offline. N√£o guarda hist√≥rico. Para compras em PDF, use o link de OCR acima.</p>

    <form method="post" enctype="multipart/form-data">
      <input type="file" name="file" accept=".xml" required>
      <button type="submit">Validar</button>
    </form>
  </div>

  {% if result %}
    <div class="card">
      <p class="ok"><b>‚úÖ {{ result }}</b></p>
      <p class="muted">Abaixo √© mostrada uma visualiza√ß√£o (HTML) de uma fatura gerada a partir do SAF-T (primeira Invoice encontrada).</p>
    </div>
  {% endif %}

  {% if errors and errors|length > 0 %}
    <div class="card">
      <h3 class="error" style="margin-top:0;">‚ùå Erros</h3>
      <ul>
        {% for e in errors %}
          <li class="error">{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- NOVO: Fatura rica (somente se XML v√°lido e invoice_view existir) -->
  {% if invoice_view %}
    <div class="card">
      <div class="invoice-wrap">
        <div class="inv-head">
          <div class="inv-head-top">
            <div>
              <p class="inv-title">Fatura (gerada a partir do SAF-T)</p>
              <div class="inv-sub">
                <div><b>N¬∫:</b> {{ invoice_view.invoice.invoice_no }} &nbsp; <span class="pill">{{ invoice_view.invoice.invoice_type }}</span></div>
                <div><b>Data:</b> {{ invoice_view.invoice.invoice_date }} &nbsp; <b>Per√≠odo:</b> {{ invoice_view.invoice.period }}</div>
                <div><b>ATCUD:</b> <span class="mono">{{ invoice_view.invoice.atcud }}</span></div>
              </div>
            </div>
            <div class="inv-badges">
              <span class="badge">Moeda: {{ invoice_view.totals.currency }}</span>
              <span class="badge">HashControl: {{ invoice_view.invoice.hash_control }}</span>
            </div>
          </div>
        </div>

        <div class="inv-body">
          <div class="grid2">
            <div class="box">
              <h3>Emitente (Fornecedor)</h3>
              <div class="kv">
                <b>{{ invoice_view.supplier.company_name }}</b><br>
                NIF: {{ invoice_view.supplier.nif }}<br>
                {{ invoice_view.supplier.address_detail }}<br>
                {{ invoice_view.supplier.postal }} {{ invoice_view.supplier.city }} ‚Äî {{ invoice_view.supplier.country }}<br>
                {% if invoice_view.supplier.email != "‚Äî" %}Email: {{ invoice_view.supplier.email }}<br>{% endif %}
                Certificado AT: {{ invoice_view.supplier.software_cert }}<br>
                Produto: {{ invoice_view.supplier.product_id }} (v{{ invoice_view.supplier.product_version }})
              </div>
            </div>

            <div class="box">
              <h3>Cliente</h3>
              <div class="kv">
                <b>{{ invoice_view.customer.company_name }}</b><br>
                NIF: {{ invoice_view.customer.nif }}<br>
                {{ invoice_view.customer.addr_detail }}<br>
                {{ invoice_view.customer.postal }} {{ invoice_view.customer.city }} ‚Äî {{ invoice_view.customer.country }}<br>
                {% if invoice_view.customer.contact != "‚Äî" %}Contato: {{ invoice_view.customer.contact }}<br>{% endif %}
              </div>
            </div>
          </div>

          {% if invoice_view.shipping %}
            <div class="grid2" style="margin-top:14px;">
              <div class="box">
                <h3>Local de Expedi√ß√£o (ShipFrom)</h3>
                <div class="kv">
                  {{ invoice_view.shipping.from.addr }}<br>
                  {{ invoice_view.shipping.from.postal }} {{ invoice_view.shipping.from.city }} ‚Äî {{ invoice_view.shipping.from.country }}
                </div>
              </div>
              <div class="box">
                <h3>Local de Entrega (ShipTo)</h3>
                <div class="kv">
                  {{ invoice_view.shipping.to.addr }}<br>
                  {{ invoice_view.shipping.to.postal }} {{ invoice_view.shipping.to.city }} ‚Äî {{ invoice_view.shipping.to.country }}
                </div>
              </div>
            </div>
          {% endif %}

          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Produto</th>
                <th>Descri√ß√£o</th>
                <th class="right">Qtd</th>
                <th class="right">Pre√ßo Unit.</th>
                <th class="right">IVA</th>
                <th class="right">Total Linha</th>
              </tr>
            </thead>
            <tbody>
              {% for l in invoice_view.lines %}
              <tr>
                <td>{{ l.line_number }}</td>
                <td>
                  <b>{{ l.product_code }}</b><br>
                  <span class="muted">{{ l.product_desc }}</span>
                </td>
                <td>
                  {{ l.description }}
                  {% if l.exemption_code != "‚Äî" or l.exemption_reason != "‚Äî" %}
                    <div class="muted" style="margin-top:6px;">
                      Isen√ß√£o: <b>{{ l.exemption_code }}</b> ‚Äî {{ l.exemption_reason }}
                    </div>
                  {% endif %}
                </td>
                <td class="right">{{ l.qty }} <span class="muted">{{ l.uom }}</span></td>
                <td class="right">{{ l.unit_price }}</td>
                <td class="right">{{ l.tax_pct }}% <span class="muted">{{ l.tax_code }}</span></td>
                <td class="right">
                  {% if l.credit_amount != "‚Äî" %}{{ l.credit_amount }}{% else %}{{ l.debit_amount }}{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="totals">
            <div class="box">
              <h3>Totais</h3>
              <div class="tot-line"><span>Base (NetTotal)</span><span>{{ invoice_view.totals.net }} {{ invoice_view.totals.currency }}</span></div>
              <div class="tot-line"><span>IVA (TaxPayable)</span><span>{{ invoice_view.totals.tax }} {{ invoice_view.totals.currency }}</span></div>
              <div class="tot-line"><strong>Total</strong><strong>{{ invoice_view.totals.gross }} {{ invoice_view.totals.currency }}</strong></div>
            </div>
          </div>

          <div class="footnote">
            <div><b>Hash:</b> <span class="mono">{{ invoice_view.invoice.hash }}</span></div>
            <div class="muted" style="margin-top:6px;">
              ‚ÑπÔ∏è Visualiza√ß√£o gerada a partir do SAF-T (primeira fatura encontrada). N√£o substitui o documento fiscal emitido pelo software.
            </div>
          </div>

        </div>
      </div>
    </div>
  {% endif %}

</div>
</body>
</html>
